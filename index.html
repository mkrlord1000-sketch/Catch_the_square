<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>–ü–æ–π–º–∞–π –∫–≤–∞–¥—Ä–∞—Ç ‚Äî v0.4</title>
<style>
  :root{
    --bg-a: #0b1220;
    --bg-b: #0f1b2b;
    --accent: #ff4d4d;
    --accent-2: #ff8a8a;
    --ui-veil: rgba(0,0,0,0.35);
    --text: #ffffff;
    --success: #4dffb8;
    --warning: #ffb84d;
    --coin-color: #ffd700;
    --border-radius: 16px;
    --transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }
  *{box-sizing:border-box}
  html,body{
    height:100%;
    margin:0;
    font-family:'Segoe UI',Inter,Arial,system-ui,sans-serif;
    background:linear-gradient(180deg,var(--bg-a),var(--bg-b));
    color:var(--text);
    -webkit-font-smoothing:antialiased;
    overflow: hidden; /* –ë–ª–æ–∫–∏—Ä—É–µ–º —Å–∫—Ä–æ–ª–ª –Ω–∞ –≤—Å–µ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ */
  }
  .bg-glow {
    position:fixed;inset:0;z-index:0;
    background: radial-gradient(600px 400px at 20% 30%, rgba(255,77,77,0.15), transparent 10%),
                radial-gradient(500px 400px at 80% 70%, rgba(255,138,138,0.10), transparent 10%);
    pointer-events:none;
    transition: var(--transition);
    animation: glowPulse 8s ease-in-out infinite;
  }
  @keyframes glowPulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.7; }
  }

  .overlay {
    position:fixed; inset:0; display:flex; align-items:center; justify-content:center; z-index:20;
    padding:16px;
    background: rgba(11, 18, 32, 0.85);
    backdrop-filter: blur(20px);
    overflow-y: auto; /* –†–∞–∑—Ä–µ—à–∞–µ–º —Å–∫—Ä–æ–ª–ª —Ç–æ–ª—å–∫–æ –≤–Ω—É—Ç—Ä–∏ –æ–≤–µ—Ä–ª–µ–µ–≤ */
    -webkit-overflow-scrolling: touch;
  }
  .panel {
    width:min(880px,94%); max-width:880px; border-radius:var(--border-radius); padding:22px;
    background: linear-gradient(180deg, rgba(255,255,255,0.05), rgba(255,255,255,0.02));
    backdrop-filter: blur(20px);
    box-shadow: 0 20px 60px rgba(0,0,0,0.8), inset 0 1px 0 rgba(255,255,255,0.1);
    display:flex; gap:20px; align-items:center; justify-content:space-between;
    border: 1px solid rgba(255,255,255,0.08);
    animation: panelSlide 0.5s ease-out;
  }
  @keyframes panelSlide {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
  }
  
  .panel.min { max-width:680px }
  h1{
    margin:0;
    font-size:22px;
    background:linear-gradient(90deg,var(--accent),var(--accent-2));
    -webkit-background-clip:text;
    -webkit-text-fill-color:transparent;
    background-clip:text;
    text-shadow: 0 4px 20px rgba(255, 77, 77, 0.3);
  }
  .desc{
    color:rgba(255,255,255,0.7);
    font-size:14px;
    margin-top:6px;
    line-height:1.4;
  }

  .controls { display:flex; gap:12px; flex-wrap:wrap; align-items:center; }
  .big-btn {
    padding:14px 22px; border-radius:14px; font-weight:700; font-size:15px;
    border: none; cursor:pointer; color: white; min-width:140px;
    background: linear-gradient(90deg, var(--accent), var(--accent-2));
    box-shadow:0 10px 25px rgba(0,0,0,0.45), inset 0 1px 0 rgba(255,255,255,0.2);
    transition: var(--transition);
    display:inline-flex; align-items:center; justify-content:center;
    flex-shrink: 0;
    position: relative;
    overflow: hidden;
  }
  .big-btn::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
    transition: left 0.5s ease;
  }
  .big-btn:hover::before {
    left: 100%;
  }
  .big-btn:hover { 
    transform: translateY(-2px); 
    box-shadow:0 16px 40px rgba(0,0,0,0.6);
  }
  .big-btn:active { transform: translateY(0px) }
  .btn-skin {
    padding:14px 20px; border-radius:12px; background:rgba(255,255,255,0.07); border:1px solid rgba(255,255,255,0.12); color:var(--text);
    min-width:140px; font-weight:700; font-size:15px; cursor:pointer; 
    box-shadow:0 6px 20px rgba(0,0,0,0.3), inset 0 1px 0 rgba(255,255,255,0.1);
    transition: var(--transition);
    flex-shrink: 0;
  }
  .btn-skin:hover { 
    background:rgba(255,255,255,0.12); 
    border-color:rgba(255,255,255,0.18);
    transform: translateY(-2px);
    box-shadow:0 10px 28px rgba(0,0,0,0.4);
  }
  .btn-skin:active { transform: translateY(1px) }

  .muted { color:rgba(255,255,255,0.6); font-size:13px }
  .coin { 
    color:var(--coin-color); 
    font-weight:bold; 
    display:inline-flex; 
    align-items:center; 
    gap:4px;
    text-shadow: 0 0 15px rgba(255, 215, 0, 0.5);
  }

  #game {
    position:relative; width:100%; height:100vh; overflow:hidden; z-index:1;
    display:none;
  }

  #hud { 
    position:absolute; top:16px; left:16px; right:16px; display:flex; gap:10px; z-index:10; justify-content:space-between;
    pointer-events: none;
  }
  .chip {
    background:rgba(0, 0, 0, 0.4); padding:10px 16px; border-radius:14px; font-weight:700; font-size:15px;
    box-shadow: 0 10px 28px rgba(0,0,0,0.6), inset 0 1px 0 rgba(255,255,255,0.1); backdrop-filter: blur(12px);
    border: 1px solid rgba(255,255,255,0.08);
    display:flex; align-items:center; gap:8px;
    animation: hudSlide 0.5s ease-out;
  }
  @keyframes hudSlide {
    from { opacity: 0; transform: translateY(-20px); }
    to { opacity: 1; transform: translateY(0); }
  }
  .user-chip { display:flex; align-items:center; gap:8px }
  .avatar { 
    width:28px; height:28px; border-radius:50%; 
    background:linear-gradient(135deg,var(--accent),var(--accent-2));
    border: 2px solid rgba(255,255,255,0.1);
    box-shadow: 0 4px 10px rgba(0,0,0,0.3);
  }

  #square {
    position:absolute; width:85px; height:85px; border-radius:16px; cursor:pointer; z-index:6;
    display:block; touch-action: manipulation; user-select:none;
    transition: transform 0.2s cubic-bezier(.2,.8,.2,1), box-shadow 0.3s ease, filter 0.3s, opacity 0.3s;
    box-shadow: 0 16px 40px rgba(0,0,0,0.6), inset 0 -6px 18px rgba(0,0,0,0.2), inset 0 3px 6px rgba(255,255,255,0.1);
    filter: brightness(1.1);
    animation: squareFloat 6s ease-in-out infinite;
    border: 1px solid rgba(255,255,255,0.1);
  }
  @keyframes squareFloat {
    0%, 100% { transform: translateY(0px) rotate(0deg); }
    50% { transform: translateY(-8px) rotate(2deg); }
  }
  #square:hover { 
    transform: scale(1.12) rotate(5deg); 
    filter: brightness(1.3);
    box-shadow: 0 20px 50px rgba(0,0,0,0.7), 0 0 30px rgba(255,77,77,0.3);
  }
  #square.active { animation: squareClick 0.3s ease; }
  @keyframes squareClick {
    0% { transform: scale(1); }
    50% { transform: scale(0.9); }
    100% { transform: scale(1); }
  }

  .pop {
    position:absolute; z-index:12; pointer-events:none; transform-origin:center;
    font-weight:900; text-shadow:0 4px 20px rgba(0,0,0,0.8);
    animation: floatUp 0.7s cubic-bezier(.2,.8,.2,1) forwards;
  }
  @keyframes floatUp {
    0% { opacity:1; transform:translateY(0) scale(1) rotate(0deg); }
    100% { opacity:0; transform:translateY(-40px) scale(0.8) rotate(10deg); }
  }

  #resultPanel, #settingsPanel, #authPanel, #shopPanel, #leaderboardPanel, #difficultyPanel { 
    display:none; position:fixed; inset:0; align-items:flex-start; justify-content:center; z-index:30; padding:16px;
    background: rgba(11, 18, 32, 0.9);
    backdrop-filter: blur(20px);
    overflow-y: auto;
    -webkit-overflow-scrolling: touch;
  }
  .result-card, .settings-card, .auth-card, .shop-card, .leaderboard-card, .difficulty-card { 
    background:linear-gradient(180deg,rgba(255,255,255,0.06),rgba(255,255,255,0.03)); padding:24px; border-radius:18px; 
    width:min(500px,92%); margin: 20px 0; box-shadow:0 25px 60px rgba(0,0,0,0.8), inset 0 1px 0 rgba(255,255,255,0.1); border:1px solid rgba(255,255,255,0.1);
    animation: cardAppear 0.4s ease-out;
  }
  @keyframes cardAppear {
    from { opacity: 0; transform: scale(0.95) translateY(20px); }
    to { opacity: 1; transform: scale(1) translateY(0); }
  }
  .result-score { 
    font-size:40px; font-weight:900; margin:12px 0 20px 0;
    background:linear-gradient(90deg, var(--accent), var(--accent-2));
    -webkit-background-clip:text;
    -webkit-text-fill-color:transparent;
    text-shadow: 0 0 25px rgba(255, 77, 77, 0.4);
  }

  .skins-grid { 
    display:grid; 
    grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); 
    gap:12px; 
    margin-top:18px;
    justify-content: center;
  }
  .skin-card { 
    width:100%; aspect-ratio: 1/1; border-radius:14px; cursor:pointer; border:2px solid transparent; 
    box-shadow:0 10px 30px rgba(0,0,0,0.5); transition: var(--transition);
    position:relative; overflow:hidden;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
  }
  .skin-card::after {
    content: '';
    position: absolute;
    inset: 0;
    border-radius: 12px;
    border: 2px solid transparent;
    background: linear-gradient(135deg, rgba(255,255,255,0.2), rgba(255,255,255,0)) border-box;
    -webkit-mask: linear-gradient(#fff 0 0) padding-box, linear-gradient(#fff 0 0);
    -webkit-mask-composite: xor;
    mask-composite: exclude;
  }
  .skin-card:hover { 
    transform:translateY(-5px) scale(1.05); 
    box-shadow:0 16px 40px rgba(0,0,0,0.6);
  }
  .skin-card.selected { 
    transform:translateY(-6px) scale(1.08); 
    border-color:var(--accent); 
    box-shadow:0 0 35px rgba(255,77,77,0.5), 0 16px 45px rgba(0,0,0,0.6);
  }
  .skin-card.locked { 
    filter:grayscale(0.9) brightness(0.6); 
    cursor:not-allowed;
  }
  .skin-card.locked::before {
    content: 'üîí';
    position: absolute;
    font-size: 22px;
    z-index: 2;
    opacity: 0.8;
  }
  .skin-price { 
    position:absolute; 
    bottom:6px; 
    right:6px; 
    background:rgba(0,0,0,0.8); 
    padding:4px 8px; 
    border-radius:8px; 
    font-size:11px;
    font-weight: bold;
    backdrop-filter: blur(4px);
  }
  .skin-name {
    position:absolute;
    top:6px;
    left:6px;
    background:rgba(0,0,0,0.8);
    padding:3px 8px;
    border-radius:6px;
    font-size:10px;
    font-weight: 600;
    max-width: calc(100% - 12px);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    backdrop-filter: blur(4px);
  }

  .input-group { margin-bottom:16px }
  .input-label { display:block; margin-bottom:6px; color:rgba(255,255,255,0.9); font-size:14px; font-weight:500 }
  .input-field { 
    width:100%; padding:14px; border-radius:12px; background:rgba(255,255,255,0.07); border:1px solid rgba(255,255,255,0.15); color:white; font-size:15px;
    transition: var(--transition);
  }
  .input-field:focus { 
    outline:none; border-color:var(--accent); background:rgba(255,255,255,0.1);
    box-shadow: 0 0 0 3px rgba(255, 77, 77, 0.1);
  }

  .settings-option { 
    display:flex; justify-content:space-between; align-items:center; margin-bottom:14px; padding:12px; 
    background:rgba(255,255,255,0.04); border-radius:12px; border: 1px solid rgba(255,255,255,0.05);
    transition: var(--transition);
  }
  .settings-option:hover {
    background:rgba(255,255,255,0.06);
  }
  .toggle-switch { position:relative; display:inline-block; width:50px; height:26px }
  .toggle-switch input { opacity:0; width:0; height:0 }
  .toggle-slider { 
    position:absolute; cursor:pointer; top:0;left:0;right:0;bottom:0; background:rgba(255,255,255,0.15); transition:.3s; border-radius:34px;
    box-shadow: inset 0 2px 4px rgba(0,0,0,0.2);
  }
  .toggle-slider:before { 
    position:absolute; content:""; height:20px;width:20px; left:3px;bottom:3px; background:white; transition:.3s; border-radius:50%;
    box-shadow: 0 2px 6px rgba(0,0,0,0.3);
  }
  input:checked + .toggle-slider { background:linear-gradient(90deg, var(--accent), var(--accent-2)) }
  input:checked + .toggle-slider:before { transform:translateX(24px) }

  .leaderboard-table { 
    width:100%; border-collapse:separate; border-spacing:0; margin-top:18px;
    font-size: 13px;
    border-radius: 12px;
    overflow: hidden;
  }
  .leaderboard-table th, .leaderboard-table td { 
    padding:12px 8px; text-align:center; border-bottom:1px solid rgba(255,255,255,0.07);
    white-space: nowrap;
  }
  .leaderboard-table th { 
    background:rgba(255,255,255,0.05); 
    font-weight: 600;
    color: rgba(255,255,255,0.9);
    font-size: 13px;
    padding: 12px 8px;
  }
  .leaderboard-table tbody tr { 
    transition: var(--transition);
    background:rgba(255,255,255,0.02);
  }
  .leaderboard-table tbody tr:hover { 
    background:rgba(255,255,255,0.06);
    transform: translateX(3px);
  }
  .leaderboard-table tbody tr:nth-child(1) td {
    background: linear-gradient(90deg, rgba(255, 215, 0, 0.1), transparent);
    border-left: 3px solid gold;
  }
  .leaderboard-table tbody tr:nth-child(2) td {
    background: linear-gradient(90deg, rgba(192, 192, 192, 0.1), transparent);
    border-left: 3px solid silver;
  }
  .leaderboard-table tbody tr:nth-child(3) td {
    background: linear-gradient(90deg, rgba(205, 127, 50, 0.1), transparent);
    border-left: 3px solid #cd7f32;
  }
  .leaderboard-table th:nth-child(1) { width: 15%; }
  .leaderboard-table th:nth-child(2) { width: 40%; }
  .leaderboard-table th:nth-child(3) { width: 25%; }
  .leaderboard-table th:nth-child(4) { width: 20%; }

  .small { font-size:13px; color:rgba(255,255,255,0.7) }
  .error-message { color:#ff4d4d; font-size:13px; margin-top:6px; display:none }
  .success-message { color:var(--success); font-size:13px; margin-top:6px; display:none }

  .settings-section {
    margin: 20px 0;
    padding: 14px;
    background: rgba(255,255,255,0.03);
    border-radius: 12px;
    border: 1px solid rgba(255,255,255,0.05);
  }
  .settings-section h3 {
    margin: 0 0 10px 0;
    color: var(--accent);
    font-size: 15px;
  }

  @media (max-width:768px){
    .panel { 
      flex-direction:column; 
      gap:16px;
      padding: 18px;
    }
    .controls { width:100%; justify-content:center }
    .skin-card { width:85px; height:85px }
    .skins-grid {
      grid-template-columns: repeat(3, 1fr);
    }
    .leaderboard-table {
      font-size: 12px;
    }
    .leaderboard-table th, .leaderboard-table td {
      padding: 10px 6px;
    }
    .big-btn, .btn-skin {
      min-width: 130px;
      padding: 14px 18px;
    }
    .overlay {
      padding: 12px;
      align-items: flex-start;
      padding-top: 40px;
    }
    .settings-card, .shop-card, .leaderboard-card, .auth-card, .difficulty-card, .result-card {
      margin-top: 20px;
      margin-bottom: 20px;
    }
  }
  
  @media (max-width:480px){
    .skins-grid {
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
    }
    .big-btn, .btn-skin {
      min-width: 110px;
      padding: 12px 14px;
      font-size: 14px;
    }
    h1 { font-size: 20px; }
    .settings-option {
      flex-direction: column;
      align-items: flex-start;
      gap: 10px;
    }
    .toggle-switch {
      align-self: flex-end;
    }
    .settings-card, .shop-card, .leaderboard-card {
      padding: 18px;
    }
    .chip {
      padding: 8px 12px;
      font-size: 14px;
    }
    #square {
      width: 75px;
      height: 75px;
    }
  }
</style>
</head>
<body>

<div class="bg-glow" id="bgGlow"></div>

<!-- AUTH SCREEN (–ü–ï–†–í–´–ô –≠–ö–†–ê–ù) -->
<div id="authPanel" class="overlay" style="display: flex;" aria-hidden="false">
  <div class="auth-card">
    <h1>–ü–æ–π–º–∞–π –∫–≤–∞–¥—Ä–∞—Ç v0.4</h1>
    <div class="desc">–í–æ–π–¥–∏—Ç–µ –∏–ª–∏ —Å–æ–∑–¥–∞–π—Ç–µ –∞–∫–∫–∞—É–Ω—Ç –¥–ª—è –∏–≥—Ä—ã</div>
    
    <div class="input-group">
      <label class="input-label">Email</label>
      <input type="email" id="authEmail" class="input-field" placeholder="–≤–∞—à@email.com">
    </div>
    
    <div class="input-group">
      <label class="input-label">–ü–∞—Ä–æ–ª—å</label>
      <input type="password" id="authPassword" class="input-field" placeholder="–º–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤">
    </div>
    
    <div class="error-message" id="authError"></div>
    <div class="success-message" id="authSuccess"></div>
    
    <div style="display:flex;gap:10px;margin-top:20px">
      <button class="big-btn" id="loginBtn" style="flex:1">–í–æ–π—Ç–∏</button>
      <button class="btn-skin" id="registerBtn" style="flex:1">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
    </div>
  </div>
</div>

<!-- MAIN MENU (–¢–û–õ–¨–ö–û –î–õ–Ø –ê–í–¢–û–†–ò–ó–û–í–ê–ù–ù–´–•) -->
<div id="menu" class="overlay" aria-hidden="true" style="display:none">
  <div class="panel min" role="dialog" aria-label="menu">
    <div style="flex:1">
      <h1>–ü–æ–π–º–∞–π –∫–≤–∞–¥—Ä–∞—Ç v0.4</h1>
      <div class="desc">–¢—Ä–µ–Ω–∏—Ä—É–π —Ä–µ–∞–∫—Ü–∏—é ‚Äî –∑–∞—Ä–∞–±–∞—Ç—ã–≤–∞–π Koynz</div>
      <div id="userInfo" style="margin-top:12px">
        <div class="user-chip">
          <div class="avatar"></div>
          <span id="userEmail"></span>
          <span class="coin">‚Ä¢ <span id="userKoynz">0</span> KZN</span>
        </div>
      </div>
    </div>

    <div style="display:flex;flex-direction:column;gap:14px;align-items:flex-end">
      <div class="controls" role="group" aria-label="—É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ">
        <button class="big-btn" id="playBtn">üéÆ –ò–≥—Ä–∞—Ç—å</button>
      </div>
      <div class="controls">
        <button class="btn-skin" id="openShop">üõí –ú–∞–≥–∞–∑–∏–Ω</button>
        <button class="btn-skin" id="openLeaderboard">üèÜ –¢–∞–±–ª–∏—Ü–∞ –ª–∏–¥–µ—Ä–æ–≤</button>
        <button class="btn-skin" id="openSettings">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>
        <button class="btn-skin" id="logoutButton">üö™ –í—ã–π—Ç–∏</button>
      </div>
    </div>
  </div>
</div>

<!-- DIFFICULTY SELECTION SCREEN -->
<div id="difficultyPanel" class="overlay">
  <div class="difficulty-card">
    <h1>–í—ã–±–µ—Ä–∏—Ç–µ —Å–ª–æ–∂–Ω–æ—Å—Ç—å</h1>
    <div class="desc">–°–∫–æ—Ä–æ—Å—Ç—å –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è –∫–≤–∞–¥—Ä–∞—Ç–∞ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç —Å–ª–æ–∂–Ω–æ—Å—Ç–∏</div>
    
    <div style="display:flex;flex-direction:column;gap:14px;margin-top:24px">
      <button class="big-btn" id="easyBtn">ü•â –õ—ë–≥–∫–∞—è (–º–µ–¥–ª–µ–Ω–Ω–æ)</button>
      <button class="big-btn" id="medBtn" style="background:linear-gradient(90deg,#4a7aff,#2e57ff);">ü•à –°—Ä–µ–¥–Ω—è—è (–Ω–æ—Ä–º–∞–ª—å–Ω–æ)</button>
      <button class="big-btn" id="hardBtn" style="background:linear-gradient(90deg,#ffb84d,#ff7a00);">ü•á –°–ª–æ–∂–Ω–∞—è (–±—ã—Å—Ç—Ä–æ)</button>
      <button class="btn-skin" id="backToMenuBtn">‚Üê –ù–∞–∑–∞–¥ –≤ –º–µ–Ω—é</button>
    </div>
  </div>
</div>

<!-- SETTINGS SCREEN -->
<div id="settingsPanel" class="overlay">
  <div class="settings-card">
    <h1>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h1>
    
    <div class="settings-section">
      <h3>üîä –ó–≤—É–∫</h3>
      <div class="settings-option">
        <div>
          <div style="font-weight:bold">–ó–≤—É–∫–∏ –∏–≥—Ä—ã</div>
          <div class="small">–í–∫–ª—é—á–∏—Ç—å –∑–≤—É–∫–æ–≤—ã–µ —ç—Ñ—Ñ–µ–∫—Ç—ã</div>
        </div>
        <label class="toggle-switch">
          <input type="checkbox" id="soundToggle" checked>
          <span class="toggle-slider"></span>
        </label>
      </div>
      
      <div class="settings-option">
        <div>
          <div style="font-weight:bold">–ì—Ä–æ–º–∫–æ—Å—Ç—å –∑–≤—É–∫–æ–≤</div>
          <div class="small">–£—Ä–æ–≤–µ–Ω—å –≥—Ä–æ–º–∫–æ—Å—Ç–∏ —ç—Ñ—Ñ–µ–∫—Ç–æ–≤</div>
        </div>
        <select id="soundVolume" class="input-field" style="width: auto; padding: 8px 12px;">
          <option value="0.3">–ù–∏–∑–∫–∞—è</option>
          <option value="0.7" selected>–°—Ä–µ–¥–Ω—è—è</option>
          <option value="1.0">–í—ã—Å–æ–∫–∞—è</option>
        </select>
      </div>
    </div>

    <div class="settings-section">
      <h3>‚ú® –í–∏–∑—É–∞–ª—å–Ω—ã–µ —ç—Ñ—Ñ–µ–∫—Ç—ã</h3>
      <div class="settings-option">
        <div>
          <div style="font-weight:bold">–ß–∞—Å—Ç–∏—Ü—ã –ø—Ä–∏ –∫–ª–∏–∫–µ</div>
          <div class="small">–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å —ç—Ñ—Ñ–µ–∫—Ç—ã —á–∞—Å—Ç–∏—Ü</div>
        </div>
        <label class="toggle-switch">
          <input type="checkbox" id="particlesToggle" checked>
          <span class="toggle-slider"></span>
        </label>
      </div>
      
      <div class="settings-option">
        <div>
          <div style="font-weight:bold">–ü–ª–∞–≤–∞—é—â–∞—è –∞–Ω–∏–º–∞—Ü–∏—è</div>
          <div class="small">–ü–ª–∞–≤–Ω–æ–µ –¥–≤–∏–∂–µ–Ω–∏–µ –∫–≤–∞–¥—Ä–∞—Ç–∞</div>
        </div>
        <label class="toggle-switch">
          <input type="checkbox" id="floatAnimationToggle" checked>
          <span class="toggle-slider"></span>
        </label>
      </div>
      
      <div class="settings-option">
        <div>
          <div style="font-weight:bold">–¢–µ–Ω—å –∫–≤–∞–¥—Ä–∞—Ç–∞</div>
          <div class="small">–≠—Ñ—Ñ–µ–∫—Ç —Ç–µ–Ω–∏ –ø–æ–¥ –∫–≤–∞–¥—Ä–∞—Ç–æ–º</div>
        </div>
        <label class="toggle-switch">
          <input type="checkbox" id="shadowToggle" checked>
          <span class="toggle-slider"></span>
        </label>
      </div>
      
      <div class="settings-option">
        <div>
          <div style="font-weight:bold">–≠—Ñ—Ñ–µ–∫—Ç –∫–ª–∏–∫–∞</div>
          <div class="small">–ê–Ω–∏–º–∞—Ü–∏—è –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ –Ω–∞ –∫–≤–∞–¥—Ä–∞—Ç</div>
        </div>
        <label class="toggle-switch">
          <input type="checkbox" id="clickEffectToggle" checked>
          <span class="toggle-slider"></span>
        </label>
      </div>
    </div>

    <div class="settings-section">
      <h3>üì± –£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ</h3>
      <div class="settings-option">
        <div>
          <div style="font-weight:bold">–í–∏–±—Ä–æ–æ—Ç–∫–ª–∏–∫</div>
          <div class="small">–í–∏–±—Ä–∞—Ü–∏—è –ø—Ä–∏ –∫–∞—Å–∞–Ω–∏–∏ (–º–æ–±–∏–ª—å–Ω—ã–µ)</div>
        </div>
        <label class="toggle-switch">
          <input type="checkbox" id="vibrationToggle">
          <span class="toggle-slider"></span>
        </label>
      </div>
      
      <div class="settings-option">
        <div>
          <div style="font-weight:bold">–ó–∞–¥–µ—Ä–∂–∫–∞ —Ç–∞–ø–∞</div>
          <div class="small">–ó–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –¥–≤–æ–π–Ω–æ–≥–æ —Ç–∞–ø–∞</div>
        </div>
        <label class="toggle-switch">
          <input type="checkbox" id="tapDelayToggle" checked>
          <span class="toggle-slider"></span>
        </label>
      </div>
    </div>

    <div class="settings-section">
      <h3>üéÆ –ò–≥—Ä–æ–≤–æ–π –ø—Ä–æ—Ü–µ—Å—Å</h3>
      <div class="settings-option">
        <div>
          <div style="font-weight:bold">–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å —Ç–∞–π–º–µ—Ä</div>
          <div class="small">–û—Ç–æ–±—Ä–∞–∂–∞—Ç—å –æ—Å—Ç–∞–≤—à–µ–µ—Å—è –≤—Ä–µ–º—è</div>
        </div>
        <label class="toggle-switch">
          <input type="checkbox" id="timerToggle" checked>
          <span class="toggle-slider"></span>
        </label>
      </div>
      
      <div class="settings-option">
        <div>
          <div style="font-weight:bold">–ó–≤—É–∫ –æ–∫–æ–Ω—á–∞–Ω–∏—è —Ä–∞—É–Ω–¥–∞</div>
          <div class="small">–ó–≤—É–∫ –ø—Ä–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ –∏–≥—Ä—ã</div>
        </div>
        <label class="toggle-switch">
          <input type="checkbox" id="roundEndSoundToggle" checked>
          <span class="toggle-slider"></span>
        </label>
      </div>
      
      <div class="settings-option">
        <div>
          <div style="font-weight:bold">–°–≤–µ—Ç–æ–≤—ã–µ —ç—Ñ—Ñ–µ–∫—Ç—ã</div>
          <div class="small">–î–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–µ —Å–≤–µ—á–µ–Ω–∏–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞</div>
        </div>
        <label class="toggle-switch">
          <input type="checkbox" id="lightEffectsToggle" checked>
          <span class="toggle-slider"></span>
        </label>
      </div>
    </div>
    
    <div style="display:flex;gap:10px;margin-top:24px">
      <button class="big-btn" id="saveSettings" style="flex:1">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      <button class="btn-skin" id="closeSettings">‚úï –ó–∞–∫—Ä—ã—Ç—å</button>
    </div>
  </div>
</div>

<!-- SHOP SCREEN -->
<div id="shopPanel" class="overlay">
  <div class="shop-card">
    <h1>üõí –ú–∞–≥–∞–∑–∏–Ω —Å–∫–∏–Ω–æ–≤</h1>
    <div class="desc">–í–∞—à –±–∞–ª–∞–Ω—Å: <span class="coin" id="shopKoynz">0</span> KZN</div>
    
    <div class="skins-grid" id="shopGrid"></div>
    
    <div class="error-message" id="shopError"></div>
    <div class="success-message" id="shopSuccess"></div>
    
    <div style="display:flex;gap:10px;margin-top:24px">
      <button class="big-btn" id="buySkin" style="flex:1">–ö—É–ø–∏—Ç—å</button>
      <button class="btn-skin" id="closeShop">‚úï –ó–∞–∫—Ä—ã—Ç—å</button>
    </div>
  </div>
</div>

<!-- LEADERBOARD SCREEN -->
<div id="leaderboardPanel" class="overlay">
  <div class="leaderboard-card">
    <h1>üèÜ –¢–∞–±–ª–∏—Ü–∞ –ª–∏–¥–µ—Ä–æ–≤</h1>
    <div class="desc">–¢–æ–ø-10 –∏–≥—Ä–æ–∫–æ–≤ –∑–∞ –≤—Å—ë –≤—Ä–µ–º—è (–º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã)</div>
    
    <table class="leaderboard-table">
      <thead>
        <tr>
          <th>#</th>
          <th>–ò–≥—Ä–æ–∫</th>
          <th>–°—á—ë—Ç</th>
          <th>–î–∞—Ç–∞</th>
        </tr>
      </thead>
      <tbody id="leaderboardBody">
        <tr><td colspan="4" style="text-align:center">–ó–∞–≥—Ä—É–∑–∫–∞...</td></tr>
      </tbody>
    </table>
    
    <div style="display:flex;gap:10px;margin-top:24px">
      <button class="big-btn" id="refreshLeaderboard">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
      <button class="btn-skin" id="closeLeaderboard">‚úï –ó–∞–∫—Ä—ã—Ç—å</button>
    </div>
  </div>
</div>

<!-- GAME AREA -->
<div id="game" aria-hidden="true">
  <div id="hud">
    <div style="display:flex;gap:10px">
      <div class="chip"><span>–°—á—ë—Ç:</span> <span id="scoreChip">0</span></div>
      <div class="chip"><span>–í—Ä–µ–º—è:</span> <span id="timeChip">30</span>—Å</div>
      <div class="chip coin"><span>KZN:</span> <span id="koynzChip">0</span></div>
    </div>
    <div class="chip" id="userHud">
      <div class="avatar"></div>
      <span id="hudEmail"></span>
    </div>
  </div>

  <canvas id="particles" style="position:absolute;inset:0;z-index:4;pointer-events:none"></canvas>

  <div id="square" role="button" aria-label="—Ü–µ–ª—å"></div>
</div>

<!-- RESULT -->
<div id="resultPanel">
  <div class="result-card">
    <div class="small">üéâ –†–∞—É–Ω–¥ –æ–∫–æ–Ω—á–µ–Ω</div>
    <div class="result-score" id="finalScore">0</div>
    <div class="small">–ó–∞—Ä–∞–±–æ—Ç–∞–Ω–æ: <span class="coin" id="earnedKoynz">0</span> KZN</div>
    
    <div style="display:flex;gap:10px;justify-content:center;margin-top:24px">
      <button class="big-btn" id="againBtn">üîÑ –ò–≥—Ä–∞—Ç—å —Å–Ω–æ–≤–∞</button>
      <button class="btn-skin" id="menuBtn">üè† –í –º–µ–Ω—é</button>
    </div>
  </div>
</div>

<!-- Sounds -->
<audio id="sndHit" preload="auto"><source src="https://assets.mixkit.co/sfx/preview/mixkit-retro-game-emergency-alarm-1000.mp3" type="audio/mp3"></audio>
<audio id="sndStart" preload="auto"><source src="https://assets.mixkit.co/sfx/preview/mixkit-game-show-intro-music-687.mp3" type="audio/mp3"></audio>
<audio id="sndBuy" preload="auto"><source src="https://assets.mixkit.co/sfx/preview/mixkit-winning-chimes-2015.mp3" type="audio/mp3"></audio>
<audio id="sndRoundEnd" preload="auto"><source src="https://assets.mixkit.co/sfx/preview/mixkit-game-show-suspense-waiting-667.mp3" type="audio/mp3"></audio>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
/* CONFIG */
const ROUND_TIME = 30;
const KOYNZ_PER_SCORE = 0.1; // 10 –æ—á–∫–æ–≤ = 1 KZN
const SUPABASE_URL = 'https://iuaczkoegsyptbtwezzv.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml1YWN6a29lZ3N5cHRidHdlenp2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYzMjc0NzQsImV4cCI6MjA4MTkwMzQ3NH0.gul2yy6aiS-wLJBs1agQwbi9_7KjiYSTEqDqLxGirJk';

/* SKINS - —Å–∫–∏–Ω—ã */
const SKINS = [
  { id:'default', name:'–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é', price:0, accent:'#ff4d4d', accent2:'#ff8a8a', bg1:'#0b1220', bg2:'#0f1b2b', 
    style:'linear-gradient(135deg,#ff6161,#e33)', shadow:'0 0 25px rgba(255,77,77,0.5)' },
  
  { id:'neon', name:'–ù–µ–æ–Ω', price:50, accent:'#7df7ff', accent2:'#2b9cff', bg1:'#061320', bg2:'#00121a', 
    style:'linear-gradient(135deg,#7df7ff,#2b9cff)', shadow:'0 0 35px rgba(125, 247, 255, 0.6)' },
  
  { id:'gold', name:'–ó–æ–ª–æ—Ç–æ', price:100, accent:'#ffd36b', accent2:'#ffb84d', bg1:'#1b1106', bg2:'#0d0803', 
    style:'linear-gradient(135deg,#ffd36b,#ffb84d)', shadow:'0 0 45px rgba(255, 215, 0, 0.7)' },
  
  { id:'matte', name:'–ú–∞—Ç–æ–≤—ã–π', price:75, accent:'#9aa6b2', accent2:'#7f8fa0', bg1:'#0b0d10', bg2:'#0a0c0f', 
    style:'linear-gradient(135deg,#9aa6b2,#7f8fa0)', shadow:'0 0 20px rgba(154, 166, 178, 0.4)' },
  
  { id:'emoji', name:'–≠–º–æ–¥–∑–∏', price:150, accent:'#ff6b9a', accent2:'#ffb3d1', bg1:'#10071a', bg2:'#1a0022', 
    style:'url("data:image/svg+xml;utf8,' + encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" width="85" height="85"><rect rx="16" width="85" height="85" fill="%23ff6161"/><text x="50%" y="50%" font-size="36" text-anchor="middle" dominant-baseline="central">üò∫</text></svg>') + '") center/cover', 
    shadow:'0 0 30px rgba(255, 107, 154, 0.6)' },
  
  { id:'galaxy', name:'–ì–∞–ª–∞–∫—Ç–∏–∫–∞', price:200, accent:'#9d4edd', accent2:'#560bad', bg1:'#040013', bg2:'#0a0020', 
    style:'radial-gradient(circle at 30% 30%, #9d4edd, #560bad, #3a0088)', shadow:'0 0 55px rgba(157, 78, 221, 0.7)' },
  
  { id:'fire', name:'–û–≥–æ–Ω—å', price:125, accent:'#ff5400', accent2:'#ff9e00', bg1:'#1a0a00', bg2:'#0f0500', 
    style:'linear-gradient(135deg,#ff5400,#ff9e00,#ff3300)', shadow:'0 0 40px rgba(255, 84, 0, 0.7)' },
  
  { id:'crystal', name:'–ö—Ä–∏—Å—Ç–∞–ª–ª', price:175, accent:'#4deeea', accent2:'#74ee15', bg1:'#00101a', bg2:'#000a10', 
    style:'linear-gradient(135deg, rgba(77, 238, 234, 0.9), rgba(116, 238, 21, 0.7))', shadow:'0 0 45px rgba(77, 238, 234, 0.6)' },
  
  { id:'water', name:'–í–æ–¥–∞', price:140, accent:'#00b4d8', accent2:'#0077b6', bg1:'#001830', bg2:'#000d1a', 
    style:'linear-gradient(135deg, #00b4d8, #0077b6, #0096c7)', shadow:'0 0 35px rgba(0, 180, 216, 0.6)' },
  
  { id:'lava', name:'–õ–∞–≤–∞', price:165, accent:'#ff5400', accent2:'#ff0054', bg1:'#1a0000', bg2:'#0f0000', 
    style:'linear-gradient(135deg, #ff5400, #ff0054, #ff0000)', shadow:'0 0 50px rgba(255, 84, 0, 0.8)' },
  
  { id:'rainbow', name:'–†–∞–¥—É–≥–∞', price:225, accent:'#ff0000', accent2:'#9400d3', bg1:'#000000', bg2:'#000000', 
    style:'linear-gradient(135deg, #ff0000, #ff7f00, #ffff00, #00ff00, #0000ff, #4b0082, #9400d3)', shadow:'0 0 55px rgba(255, 0, 0, 0.4)' },
  
  { id:'cyber', name:'–ö–∏–±–µ—Ä–ø–∞–Ω–∫', price:190, accent:'#00ff9d', accent2:'#00b8ff', bg1:'#000514', bg2:'#000208', 
    style:'linear-gradient(135deg, #00ff9d, #00b8ff, #bd00ff)', shadow:'0 0 45px rgba(0, 255, 157, 0.6)' },
  
  { id:'midnight', name:'–ü–æ–ª–Ω–æ—á—å', price:135, accent:'#6c5ce7', accent2:'#a29bfe', bg1:'#000000', bg2:'#0a0a2a', 
    style:'linear-gradient(135deg, #6c5ce7, #a29bfe, #dab6fc)', shadow:'0 0 40px rgba(108, 92, 231, 0.6)' }
];

/* DIFFICULTIES - —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ —Å —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–º–∏ —Å–∫–æ—Ä–æ—Å—Ç—è–º–∏ */
const DIFFICULTIES = {
  easy: { name: "–õ—ë–≥–∫–∞—è", speed: 1200, description: "–ú–µ–¥–ª–µ–Ω–Ω–æ" },
  medium: { name: "–°—Ä–µ–¥–Ω—è—è", speed: 700, description: "–ù–æ—Ä–º–∞–ª—å–Ω–æ" },
  hard: { name: "–°–ª–æ–∂–Ω–∞—è", speed: 400, description: "–ë—ã—Å—Ç—Ä–æ" }
};

/* GLOBAL STATE */
let chosenSkin = SKINS[0];
let unlockedSkins = ['default'];
let currentDifficulty = DIFFICULTIES.medium;
let currentSpeed = DIFFICULTIES.medium.speed; // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â—É—é —Å–∫–æ—Ä–æ—Å—Ç—å –¥–ª—è –∫–Ω–æ–ø–∫–∏ "–ò–≥—Ä–∞—Ç—å —Å–Ω–æ–≤–∞"
let score = 0;
let timeLeft = ROUND_TIME;
let moveTimer = null;
let gameRunning = false;
let particles = [];
let particleCtx, particleCanvas;
let settings = {
  sound: true,
  soundVolume: 0.7,
  particles: true,
  vibration: false,
  floatAnimation: true,
  shadow: true,
  clickEffect: true,
  tapDelay: true,
  timer: true,
  roundEndSound: true,
  lightEffects: true
};
let user = null;
let userKoynz = 0;
let supabaseClient = null;
let lastTapTime = 0;
const TAP_DELAY = 200; // 200ms delay between taps

/* Elements */
const menu = document.getElementById('menu');
const gameArea = document.getElementById('game');
const square = document.getElementById('square');
const scoreChip = document.getElementById('scoreChip');
const timeChip = document.getElementById('timeChip');
const koynzChip = document.getElementById('koynzChip');
const resultPanel = document.getElementById('resultPanel');
const finalScore = document.getElementById('finalScore');
const earnedKoynz = document.getElementById('earnedKoynz');
const sndHit = document.getElementById('sndHit');
const sndStart = document.getElementById('sndStart');
const sndBuy = document.getElementById('sndBuy');
const sndRoundEnd = document.getElementById('sndRoundEnd');
const bgGlow = document.getElementById('bgGlow');

/* Auth Elements */
const authPanel = document.getElementById('authPanel');
const logoutButton = document.getElementById('logoutButton');
const userInfo = document.getElementById('userInfo');
const userEmail = document.getElementById('userEmail');
const userKoynzEl = document.getElementById('userKoynz');
const hudEmail = document.getElementById('hudEmail');
const userHud = document.getElementById('userHud');

/* Settings Elements */
const settingsPanel = document.getElementById('settingsPanel');
const soundToggle = document.getElementById('soundToggle');
const soundVolume = document.getElementById('soundVolume');
const particlesToggle = document.getElementById('particlesToggle');
const vibrationToggle = document.getElementById('vibrationToggle');
const floatAnimationToggle = document.getElementById('floatAnimationToggle');
const shadowToggle = document.getElementById('shadowToggle');
const clickEffectToggle = document.getElementById('clickEffectToggle');
const tapDelayToggle = document.getElementById('tapDelayToggle');
const timerToggle = document.getElementById('timerToggle');
const roundEndSoundToggle = document.getElementById('roundEndSoundToggle');
const lightEffectsToggle = document.getElementById('lightEffectsToggle');

/* Shop Elements */
const shopPanel = document.getElementById('shopPanel');
const shopGrid = document.getElementById('shopGrid');
const shopKoynz = document.getElementById('shopKoynz');
let selectedShopSkin = null;

/* Difficulty Elements */
const difficultyPanel = document.getElementById('difficultyPanel');

/* Leaderboard Elements */
const leaderboardPanel = document.getElementById('leaderboardPanel');
const leaderboardBody = document.getElementById('leaderboardBody');

/* Particle canvas setup */
const pc = document.getElementById('particles');
function resizeCanvas(){ 
  pc.width = window.innerWidth; 
  pc.height = window.innerHeight; 
  particleCtx = pc.getContext('2d'); 
}
resizeCanvas(); 
window.addEventListener('resize', resizeCanvas);

/* INIT Supabase */
function initSupabase() {
  if (!SUPABASE_URL || SUPABASE_URL.includes('your-project')) {
    console.warn('Supabase –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω. –ó–∞–º–µ–Ω–∏—Ç–µ SUPABASE_URL –∏ SUPABASE_KEY –Ω–∞ —Å–≤–æ–∏.');
    return;
  }
  supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
  checkAuth();
}

/* AUTH FUNCTIONS */
async function checkAuth() {
  if (!supabaseClient) return;
  
  const { data: { session } } = await supabaseClient.auth.getSession();
  if (session) {
    user = session.user;
    await loadUserData();
    showMainMenu();
  } else {
    showAuthScreen();
  }
}

async function loadUserData() {
  if (!user || !supabaseClient) return;
  
  try {
    const { data: profile, error } = await supabaseClient
      .from('profiles')
      .select('koynz, unlocked_skins')
      .eq('id', user.id)
      .single();
      
    if (error) {
      console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è:', error);
      return;
    }
    
    if (profile) {
      userKoynz = profile.koynz || 0;
      unlockedSkins = profile.unlocked_skins || ['default'];
      
      const savedSkinId = localStorage.getItem('selectedSkin');
      const savedSkin = SKINS.find(s => s.id === savedSkinId);
      if (savedSkin && unlockedSkins.includes(savedSkin.id)) {
        chosenSkin = savedSkin;
      } else {
        chosenSkin = SKINS[0];
      }
      
      applySkin(chosenSkin);
      updateKoynzUI();
    }
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', error);
  }
}

// ==================== –£–õ–£–ß–®–ï–ù–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –í–•–û–î–ê ====================
async function signIn(email, password) {
  if (!supabaseClient) {
    showMessage('authError', '–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞');
    return;
  }
  
  try {
    const { data, error } = await supabaseClient.auth.signInWithPassword({
      email,
      password
    });
    
    if (error) throw error;
    
    user = data.user;
    await loadUserData();
    showMainMenu();
    showMessage('authSuccess', '–£—Å–ø–µ—à–Ω—ã–π –≤—Ö–æ–¥!');
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞:', error);
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑–ª–∏—á–Ω—ã–µ —Ç–∏–ø—ã –æ—à–∏–±–æ–∫ –≤—Ö–æ–¥–∞
    const errorMsg = error.message ? error.message.toLowerCase() : '';
    if (errorMsg.includes('invalid')) {
      showMessage('authError', '–ù–µ–≤–µ—Ä–Ω—ã–π email –∏–ª–∏ –ø–∞—Ä–æ–ª—å');
    } else if (errorMsg.includes('email')) {
      showMessage('authError', 'Email –Ω–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≤–∞—à—É –ø–æ—á—Ç—É');
    } else if (errorMsg.includes('user not found')) {
      showMessage('authError', '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å —Ç–∞–∫–∏–º email –Ω–µ –Ω–∞–π–¥–µ–Ω');
    } else if (errorMsg.includes('rate limit')) {
      showMessage('authError', '–°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –ø–æ–ø—ã—Ç–æ–∫. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ');
    } else {
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–±—â—É—é –æ—à–∏–±–∫—É –¥–ª—è –¥—Ä—É–≥–∏—Ö —Å–ª—É—á–∞–µ–≤
      showMessage('authError', '–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞: ' + error.message);
    }
  }
}

// ==================== –£–õ–£–ß–®–ï–ù–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –†–ï–ì–ò–°–¢–†–ê–¶–ò–ò ====================
async function signUp(email, password) {
  if (!supabaseClient) {
    showMessage('authError', '–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞');
    return;
  }
  
  // –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–ª–∏–Ω—ã –ø–∞—Ä–æ–ª—è
  if (password.length < 6) {
    showMessage('authError', '–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –º–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤');
    return;
  }
  
  try {
    const { data: signUpData, error: signUpError } = await supabaseClient.auth.signUp({
      email,
      password,
      options: {
        emailRedirectTo: window.location.origin,
        data: { 
          koynz: 100
        }
      }
    });
    
    if (signUpError) throw signUpError;
    
    // –ï—Å–ª–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞, –ø—ã—Ç–∞–µ–º—Å—è –≤–æ–π—Ç–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
    if (signUpData.user) {
      try {
        const { data: signInData, error: signInError } = await supabaseClient.auth.signInWithPassword({
          email,
          password
        });
        
        if (signInError) throw signInError;
        
        user = signInData.user;
        await loadUserData();
        showMainMenu();
        showMessage('authSuccess', '–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞! –í—ã –≤–æ—à–ª–∏ –≤ —Å–∏—Å—Ç–µ–º—É.');
      } catch (signInError) {
        // –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å –≤–æ–π—Ç–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
        showMessage('authSuccess', '–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞! –¢–µ–ø–µ—Ä—å –≤—ã –º–æ–∂–µ—Ç–µ –≤–æ–π—Ç–∏ –≤ —Å–∏—Å—Ç–µ–º—É.');
      }
    }
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏:', error);
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑–ª–∏—á–Ω—ã–µ —Ç–∏–ø—ã –æ—à–∏–±–æ–∫
    const errorMsg = error.message ? error.message.toLowerCase() : '';
    if (errorMsg.includes('invalid')) {
      showMessage('authError', '–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –Ω–µ —É–¥–∞–ª–∞—Å—å. –≠—Ç–æ—Ç email –º–æ–∂–µ—Ç –±—ã—Ç—å —É–∂–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω, –∏–ª–∏ –ø–∞—Ä–æ–ª—å –Ω–µ–¥–æ–ø—É—Å—Ç–∏–º.');
    } else if (errorMsg.includes('email')) {
      showMessage('authError', '–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π email –∞–¥—Ä–µ—Å');
    } else if (errorMsg.includes('password')) {
      showMessage('authError', '–ü–∞—Ä–æ–ª—å –Ω–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏');
    } else if (errorMsg.includes('user') && errorMsg.includes('already')) {
      showMessage('authError', '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å —Ç–∞–∫–∏–º email —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç');
    } else if (errorMsg.includes('rate limit')) {
      showMessage('authError', '–°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –ø–æ–ø—ã—Ç–æ–∫ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ');
    } else {
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–±—â—É—é –æ—à–∏–±–∫—É –¥–ª—è –¥—Ä—É–≥–∏—Ö —Å–ª—É—á–∞–µ–≤
      showMessage('authError', '–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏: ' + error.message);
    }
  }
}

async function signOut() {
  if (!supabaseClient) return;
  
  await supabaseClient.auth.signOut();
  user = null;
  userKoynz = 0;
  unlockedSkins = ['default'];
  showAuthScreen();
  updateKoynzUI();
}

function updateKoynzUI() {
  userKoynzEl.textContent = Math.floor(userKoynz);
  shopKoynz.textContent = Math.floor(userKoynz);
  koynzChip.textContent = Math.floor(userKoynz);
}

/* SCREEN MANAGEMENT */
function showMainMenu() {
  authPanel.style.display = 'none';
  menu.style.display = 'flex';
  userEmail.textContent = user.email;
  hudEmail.textContent = user.email.substring(0, 10) + (user.email.length > 10 ? '...' : '');
}

function showAuthScreen() {
  menu.style.display = 'none';
  gameArea.style.display = 'none';
  settingsPanel.style.display = 'none';
  shopPanel.style.display = 'none';
  leaderboardPanel.style.display = 'none';
  resultPanel.style.display = 'none';
  difficultyPanel.style.display = 'none';
  authPanel.style.display = 'flex';
}

/* LEADERBOARD FUNCTIONS */
async function loadLeaderboard() {
  if (!supabaseClient) {
    leaderboardBody.innerHTML = '<tr><td colspan="4">–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞</td></tr>';
    return;
  }
  
  try {
    // –ü–æ–ª—É—á–∞–µ–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    const { data, error } = await supabaseClient
      .from('leaderboard')
      .select(`
        user_id,
        profiles!inner(email),
        score,
        created_at
      `)
      .order('score', { ascending: false })
      .limit(100);
      
    if (error) {
      leaderboardBody.innerHTML = `<tr><td colspan="4">–û—à–∏–±–∫–∞: ${error.message}</td></tr>`;
      return;
    }
    
    if (!data || data.length === 0) {
      leaderboardBody.innerHTML = '<tr><td colspan="4">–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π</td></tr>';
      return;
    }
    
    // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é, –æ—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç
    const userMaxScores = new Map();
    
    data.forEach(item => {
      const userId = item.user_id;
      const currentMax = userMaxScores.get(userId);
      
      if (!currentMax || item.score > currentMax.score) {
        userMaxScores.set(userId, {
          email: item.profiles?.email || '–ê–Ω–æ–Ω–∏–º',
          score: item.score,
          created_at: item.created_at,
          user_id: userId
        });
      }
    });
    
    // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤ –º–∞—Å—Å–∏–≤ –∏ —Å–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ —É–±—ã–≤–∞–Ω–∏—é —Å—á–µ—Ç–∞
    const sortedScores = Array.from(userMaxScores.values())
      .sort((a, b) => b.score - a.score)
      .slice(0, 10); // –ë–µ—Ä–µ–º —Ç–æ–ø-10
    
    // –ù–∞—Ö–æ–¥–∏–º –ø–æ–∑–∏—Ü–∏—é —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å
    let currentUserRank = -1;
    let currentUserEntry = null;
    
    if (user) {
      currentUserEntry = sortedScores.find(entry => entry.user_id === user.id);
      if (currentUserEntry) {
        currentUserRank = sortedScores.indexOf(currentUserEntry);
      }
    }
    
    // –û—Ç—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º —Ç–∞–±–ª–∏—Ü—É
    leaderboardBody.innerHTML = '';
    
    // –¢–æ–ø-10
    sortedScores.forEach((item, index) => {
      const row = document.createElement('tr');
      
      // –ü–æ–¥—Å–≤–µ—á–∏–≤–∞–µ–º —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
      if (user && item.user_id === user.id) {
        row.style.backgroundColor = 'rgba(255, 77, 77, 0.1)';
        row.style.borderLeft = '3px solid var(--accent)';
      }
      
      row.innerHTML = `
        <td>${index + 1}</td>
        <td>${item.email} ${user && item.user_id === user.id ? '(–í—ã)' : ''}</td>
        <td>${item.score}</td>
        <td>${new Date(item.created_at).toLocaleDateString()}</td>
      `;
      leaderboardBody.appendChild(row);
    });
    
    // –ï—Å–ª–∏ —Ç–µ–∫—É—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –≤ —Ç–æ–ø-10, –Ω–æ –µ—Å—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –µ–≥–æ –æ—Ç–¥–µ–ª—å–Ω–æ
    if (user && currentUserRank === -1) {
      // –ò—â–µ–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
      const { data: userData, error: userError } = await supabaseClient
        .from('leaderboard')
        .select('score, created_at')
        .eq('user_id', user.id)
        .order('score', { ascending: false })
        .limit(1)
        .single();
      
      if (userData && !userError) {
        // –ò—â–µ–º –æ–±—â—É—é –ø–æ–∑–∏—Ü–∏—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å—Ä–µ–¥–∏ –≤—Å–µ—Ö
        const { data: allData } = await supabaseClient
          .from('leaderboard')
          .select('user_id, score')
          .order('score', { ascending: false });
        
        if (allData) {
          // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –≤—Å–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
          const allUserMaxScores = new Map();
          allData.forEach(item => {
            const userId = item.user_id;
            const currentMax = allUserMaxScores.get(userId);
            if (!currentMax || item.score > currentMax.score) {
              allUserMaxScores.set(userId, {
                score: item.score,
                user_id: userId
              });
            }
          });
          
          // –°–æ—Ä—Ç–∏—Ä—É–µ–º –≤—Å–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
          const allSortedScores = Array.from(allUserMaxScores.values())
            .sort((a, b) => b.score - a.score);
          
          // –ù–∞—Ö–æ–¥–∏–º –ø–æ–∑–∏—Ü–∏—é —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
          const userGlobalIndex = allSortedScores.findIndex(entry => entry.user_id === user.id);
          
          if (userGlobalIndex !== -1) {
            const separator = document.createElement('tr');
            separator.innerHTML = '<td colspan="4" style="text-align:center; padding: 8px; color: rgba(255,255,255,0.5)">‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ</td>';
            leaderboardBody.appendChild(separator);
            
            const userRow = document.createElement('tr');
            userRow.style.backgroundColor = 'rgba(255, 77, 77, 0.15)';
            userRow.style.borderLeft = '3px solid var(--accent)';
            userRow.innerHTML = `
              <td>${userGlobalIndex + 1}</td>
              <td>${user.email} (–í—ã)</td>
              <td>${userData.score}</td>
              <td>${new Date(userData.created_at).toLocaleDateString()}</td>
            `;
            leaderboardBody.appendChild(userRow);
          }
        }
      }
    }
    
  } catch (error) {
    leaderboardBody.innerHTML = `<tr><td colspan="4">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</td></tr>`;
    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–∞–±–ª–∏—Ü—ã –ª–∏–¥–µ—Ä–æ–≤:', error);
  }
}

async function saveScore(score) {
  if (!user || !supabaseClient) return 0;
  
  try {
    const { error } = await supabaseClient
      .from('leaderboard')
      .insert([
        { user_id: user.id, score: score }
      ]);
      
    if (error) {
      console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å—á—ë—Ç–∞:', error);
      return 0;
    }
    
    const earned = Math.floor(score * KOYNZ_PER_SCORE);
    userKoynz += earned;
    
    await supabaseClient
      .from('profiles')
      .update({ koynz: userKoynz })
      .eq('id', user.id);
    
    updateKoynzUI();
    return earned;
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞:', error);
    return 0;
  }
}

/* SHOP FUNCTIONS */
function buildShop() {
  shopGrid.innerHTML = '';
  selectedShopSkin = null;
  
  SKINS.forEach(skin => {
    const el = document.createElement('div');
    el.className = 'skin-card';
    el.style.background = skin.style;
    
    const isUnlocked = unlockedSkins.includes(skin.id);
    const isSelected = skin.id === chosenSkin.id;
    
    if (isUnlocked) {
      if (isSelected) {
        el.classList.add('selected');
        selectedShopSkin = skin;
      }
    } else {
      el.classList.add('locked');
    }
    
    el.innerHTML = `
      <div class="skin-name">${skin.name}</div>
      ${!isUnlocked ? `<div class="skin-price"><span class="coin">${skin.price}</span> KZN</div>` : ''}
    `;
    
    el.addEventListener('click', () => selectShopSkin(skin));
    el.dataset.skinId = skin.id;
    shopGrid.appendChild(el);
  });
  
  updateBuyButton();
}

function selectShopSkin(skin) {
  const isUnlocked = unlockedSkins.includes(skin.id);
  
  if (!isUnlocked) {
    const cards = shopGrid.querySelectorAll('.skin-card');
    cards.forEach(card => {
      card.classList.remove('selected');
    });
    
    const selectedCard = shopGrid.querySelector(`[data-skin-id="${skin.id}"]`);
    if (selectedCard) {
      selectedCard.classList.add('selected');
      selectedShopSkin = skin;
    }
    
    updateBuyButton();
    return;
  }
  
  chosenSkin = skin;
  localStorage.setItem('selectedSkin', skin.id);
  applySkin(skin);
  
  const cards = shopGrid.querySelectorAll('.skin-card');
  cards.forEach(card => {
    card.classList.remove('selected');
    if (card.dataset.skinId === skin.id) {
      card.classList.add('selected');
      selectedShopSkin = skin;
    }
  });
  
  updateBuyButton();
}

function updateBuyButton() {
  const buyBtn = document.getElementById('buySkin');
  if (!selectedShopSkin) {
    buyBtn.textContent = '–ö—É–ø–∏—Ç—å';
    buyBtn.disabled = true;
    buyBtn.style.opacity = '0.5';
    return;
  }
  
  const isUnlocked = unlockedSkins.includes(selectedShopSkin.id);
  if (isUnlocked) {
    buyBtn.textContent = '–í—ã–±—Ä–∞–Ω';
    buyBtn.disabled = true;
    buyBtn.style.opacity = '0.5';
  } else {
    buyBtn.textContent = `–ö—É–ø–∏—Ç—å –∑–∞ ${selectedShopSkin.price} KZN`;
    buyBtn.disabled = false;
    buyBtn.style.opacity = '1';
  }
}

async function buySkin() {
  if (!user) {
    showMessage('shopError', '–í–æ–π–¥–∏—Ç–µ –¥–ª—è –ø–æ–∫—É–ø–∫–∏');
    return;
  }
  
  if (!supabaseClient) {
    showMessage('shopError', '–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞');
    return;
  }
  
  if (!selectedShopSkin) {
    showMessage('shopError', '–í—ã–±–µ—Ä–∏—Ç–µ —Å–∫–∏–Ω –¥–ª—è –ø–æ–∫—É–ø–∫–∏');
    return;
  }
  
  if (unlockedSkins.includes(selectedShopSkin.id)) {
    showMessage('shopError', '–°–∫–∏–Ω —É–∂–µ –∫—É–ø–ª–µ–Ω');
    return;
  }
  
  if (userKoynz < selectedShopSkin.price) {
    showMessage('shopError', '–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ KZN');
    return;
  }
  
  const oldKoynz = userKoynz;
  userKoynz -= selectedShopSkin.price;
  unlockedSkins.push(selectedShopSkin.id);
  
  try {
    const { error } = await supabaseClient
      .from('profiles')
      .update({ 
        koynz: userKoynz,
        unlocked_skins: unlockedSkins
      })
      .eq('id', user.id);
    
    if (error) throw error;
    
    chosenSkin = selectedShopSkin;
    localStorage.setItem('selectedSkin', chosenSkin.id);
    applySkin(chosenSkin);
    
    if (settings.sound) {
      sndBuy.volume = settings.soundVolume;
      sndBuy.currentTime = 0;
      sndBuy.play().catch(() => {});
    }
    
    updateKoynzUI();
    buildShop();
    
    showMessage('shopSuccess', `–°–∫–∏–Ω "${selectedShopSkin.name}" –∫—É–ø–ª–µ–Ω!`, true);
    
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∫—É–ø–∫–µ —Å–∫–∏–Ω–∞:', error);
    userKoynz = oldKoynz;
    unlockedSkins = unlockedSkins.filter(id => id !== selectedShopSkin.id);
    updateKoynzUI();
    showMessage('shopError', '–û—à–∏–±–∫–∞ –ø–æ–∫—É–ø–∫–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.');
  }
}

/* UI UTILITIES */
function showMessage(elementId, text, isSuccess = false) {
  const el = document.getElementById(elementId);
  el.textContent = text;
  el.style.display = 'block';
  el.style.color = isSuccess ? 'var(--success)' : 'var(--accent)';
  setTimeout(() => el.style.display = 'none', 3000);
}

/* UI WIRING */
document.getElementById('playBtn').addEventListener('click', () => {
  menu.style.display = 'none';
  difficultyPanel.style.display = 'flex';
});

// –°–ª–æ–∂–Ω–æ—Å—Ç–∏
document.getElementById('easyBtn').addEventListener('click', () => {
  currentDifficulty = DIFFICULTIES.easy;
  currentSpeed = DIFFICULTIES.easy.speed;
  start(currentSpeed);
});

document.getElementById('medBtn').addEventListener('click', () => {
  currentDifficulty = DIFFICULTIES.medium;
  currentSpeed = DIFFICULTIES.medium.speed;
  start(currentSpeed);
});

document.getElementById('hardBtn').addEventListener('click', () => {
  currentDifficulty = DIFFICULTIES.hard;
  currentSpeed = DIFFICULTIES.hard.speed;
  start(currentSpeed);
});

// –ù–∞–∑–∞–¥ –∏–∑ –≤—ã–±–æ—Ä–∞ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏
document.getElementById('backToMenuBtn').addEventListener('click', () => {
  difficultyPanel.style.display = 'none';
  menu.style.display = 'flex';
});

// –û—Ç–∫—Ä—ã—Ç–∏–µ –ø–∞–Ω–µ–ª–µ–π
document.getElementById('openShop').addEventListener('click', () => { 
  menu.style.display = 'none'; 
  shopPanel.style.display = 'flex'; 
  buildShop(); 
});

document.getElementById('openLeaderboard').addEventListener('click', async () => { 
  menu.style.display = 'none'; 
  leaderboardPanel.style.display = 'flex'; 
  await loadLeaderboard(); 
});

document.getElementById('openSettings').addEventListener('click', () => { 
  menu.style.display = 'none'; 
  settingsPanel.style.display = 'flex'; 
  soundToggle.checked = settings.sound;
  soundVolume.value = settings.soundVolume.toString();
  particlesToggle.checked = settings.particles;
  vibrationToggle.checked = settings.vibration;
  floatAnimationToggle.checked = settings.floatAnimation;
  shadowToggle.checked = settings.shadow;
  clickEffectToggle.checked = settings.clickEffect;
  tapDelayToggle.checked = settings.tapDelay;
  timerToggle.checked = settings.timer;
  roundEndSoundToggle.checked = settings.roundEndSound;
  lightEffectsToggle.checked = settings.lightEffects;
});

document.getElementById('logoutButton').addEventListener('click', signOut);

// Auth panel
document.getElementById('loginBtn').addEventListener('click', async () => {
  const email = document.getElementById('authEmail').value.trim();
  const password = document.getElementById('authPassword').value;
  
  if (!email || !password) {
    showMessage('authError', '–í–≤–µ–¥–∏—Ç–µ email –∏ –ø–∞—Ä–æ–ª—å');
    return;
  }
  
  try {
    await signIn(email, password);
  } catch (error) {
    // –û—à–∏–±–∫–∏ —É–∂–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –≤–Ω—É—Ç—Ä–∏ signIn
  }
});

document.getElementById('registerBtn').addEventListener('click', async () => {
  const email = document.getElementById('authEmail').value.trim();
  const password = document.getElementById('authPassword').value;
  
  if (!email || !password) {
    showMessage('authError', '–í–≤–µ–¥–∏—Ç–µ email –∏ –ø–∞—Ä–æ–ª—å');
    return;
  }
  
  try {
    await signUp(email, password);
  } catch (error) {
    // –û—à–∏–±–∫–∏ —É–∂–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –≤–Ω—É—Ç—Ä–∏ signUp
  }
});

// Settings panel
document.getElementById('saveSettings').addEventListener('click', () => {
  settings.sound = soundToggle.checked;
  settings.soundVolume = parseFloat(soundVolume.value);
  settings.particles = particlesToggle.checked;
  settings.vibration = vibrationToggle.checked;
  settings.floatAnimation = floatAnimationToggle.checked;
  settings.shadow = shadowToggle.checked;
  settings.clickEffect = clickEffectToggle.checked;
  settings.tapDelay = tapDelayToggle.checked;
  settings.timer = timerToggle.checked;
  settings.roundEndSound = roundEndSoundToggle.checked;
  settings.lightEffects = lightEffectsToggle.checked;
  
  localStorage.setItem('gameSettings', JSON.stringify(settings));
  applySettings();
  settingsPanel.style.display = 'none';
  menu.style.display = 'flex';
});

document.getElementById('closeSettings').addEventListener('click', () => { 
  settingsPanel.style.display = 'none'; 
  menu.style.display = 'flex'; 
});

// Shop panel
document.getElementById('buySkin').addEventListener('click', buySkin);
document.getElementById('closeShop').addEventListener('click', () => { 
  shopPanel.style.display = 'none'; 
  menu.style.display = 'flex'; 
});

// Leaderboard panel
document.getElementById('refreshLeaderboard').addEventListener('click', loadLeaderboard);
document.getElementById('closeLeaderboard').addEventListener('click', () => { 
  leaderboardPanel.style.display = 'none'; 
  menu.style.display = 'flex'; 
});

// Game buttons
document.getElementById('againBtn').addEventListener('click', () => { 
  resultPanel.style.display = 'none'; 
  start(currentSpeed); // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—É—é —Å–∫–æ—Ä–æ—Å—Ç—å
});

document.getElementById('menuBtn').addEventListener('click', () => { 
  resultPanel.style.display = 'none'; 
  menu.style.display = 'flex'; 
  gameArea.style.display = 'none'; 
});

/* SKIN FUNCTIONS */
function applySkin(s){
  document.documentElement.style.setProperty('--accent', s.accent);
  document.documentElement.style.setProperty('--accent-2', s.accent2);
  document.documentElement.style.setProperty('--bg-a', s.bg1);
  document.documentElement.style.setProperty('--bg-b', s.bg2);
  
  if (settings.lightEffects) {
    bgGlow.style.background = `radial-gradient(600px 400px at 20% 30%, ${hexToRgba(s.accent,0.15)}, transparent 10%), radial-gradient(500px 400px at 80% 70%, ${hexToRgba(s.accent2,0.10)}, transparent 10%)`;
  } else {
    bgGlow.style.background = 'none';
  }
  
  square.style.background = s.style;
  if (settings.shadow && s.shadow) {
    square.style.boxShadow = `0 16px 40px rgba(0,0,0,0.6), inset 0 -6px 18px rgba(0,0,0,0.2), inset 0 3px 6px rgba(255,255,255,0.1), ${s.shadow}`;
  } else {
    square.style.boxShadow = '0 16px 40px rgba(0,0,0,0.6), inset 0 -6px 18px rgba(0,0,0,0.2), inset 0 3px 6px rgba(255,255,255,0.1)';
  }
}

function hexToRgba(hex, a){
  if(hex.startsWith('#')){
    const r = parseInt(hex.slice(1,3),16), g=parseInt(hex.slice(3,5),16), b=parseInt(hex.slice(5,7),16);
    return `rgba(${r},${g},${b},${a})`;
  }
  return hex;
}

/* SETTINGS APPLY */
function applySettings() {
  // –ü—Ä–∏–º–µ–Ω—è–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∑–≤—É–∫–∞
  sndHit.volume = settings.sound ? settings.soundVolume : 0;
  sndStart.volume = settings.sound ? settings.soundVolume : 0;
  sndBuy.volume = settings.sound ? settings.soundVolume : 0;
  sndRoundEnd.volume = settings.sound ? settings.soundVolume : 0;
  
  // –ü—Ä–∏–º–µ–Ω—è–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∞–Ω–∏–º–∞—Ü–∏–∏
  if (settings.floatAnimation) {
    square.style.animation = 'squareFloat 6s ease-in-out infinite';
  } else {
    square.style.animation = 'none';
  }
  
  // –ü—Ä–∏–º–µ–Ω—è–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Ç–µ–Ω–∏
  applySkin(chosenSkin); // –¢–µ–Ω—å –æ–±–Ω–æ–≤–∏—Ç—Å—è –≤–Ω—É—Ç—Ä–∏ applySkin
  
  // –ü—Ä–∏–º–µ–Ω—è–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Ç–∞–π–º–µ—Ä–∞
  timeChip.style.display = settings.timer ? 'inline' : 'none';
  
  // –ü—Ä–∏–º–µ–Ω—è–µ–º —Å–≤–µ—Ç–æ–≤—ã–µ —ç—Ñ—Ñ–µ–∫—Ç—ã
  applySkin(chosenSkin); // –°–≤–µ—Ç–æ–≤—ã–µ —ç—Ñ—Ñ–µ–∫—Ç—ã –æ–±–Ω–æ–≤—è—Ç—Å—è –≤–Ω—É—Ç—Ä–∏ applySkin
}

/* GAME FUNCTIONS */
function start(speed){
  score = 0; 
  timeLeft = ROUND_TIME; 
  scoreChip.textContent = score; 
  timeChip.textContent = timeLeft;
  difficultyPanel.style.display = 'none';
  gameArea.style.display = 'block'; 
  gameArea.setAttribute('aria-hidden','false');
  
  moveSquare();
  clearInterval(moveTimer);
  moveTimer = setInterval(moveSquare, speed);
  gameRunning = true;
  
  if(settings.sound) {
    sndStart.volume = settings.soundVolume;
    sndStart.currentTime = 0; 
    sndStart.play().catch(()=>{});
  }
  
  tickTimer();
}

let tickInterval = null;
function tickTimer(){
  clearInterval(tickInterval);
  tickInterval = setInterval(()=>{
    timeLeft--; 
    timeChip.textContent = timeLeft;
    if(timeLeft<=0) finish();
  },1000);
}

async function finish(){
  clearInterval(moveTimer); 
  clearInterval(tickInterval); 
  gameRunning=false;
  
  if (settings.roundEndSound && settings.sound) {
    sndRoundEnd.volume = settings.soundVolume;
    sndRoundEnd.currentTime = 0;
    sndRoundEnd.play().catch(()=>{});
  }
  
  const earned = await saveScore(score);
  
  finalScore.textContent = score;
  earnedKoynz.textContent = earned;
  resultPanel.style.display='flex';
}

function moveSquare(){
  const margin = 100;
  const maxX = Math.max(window.innerWidth - margin, 20);
  const maxY = Math.max(window.innerHeight - margin, 20);
  const x = Math.round(Math.random()*maxX);
  const y = Math.round(Math.random()*maxY);
  square.style.left = x+'px'; 
  square.style.top = y+'px';
}

square.addEventListener('pointerdown', async (e)=>{
  if(!gameRunning) return;
  
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–∞–¥–µ—Ä–∂–∫—É —Ç–∞–ø–∞
  const now = Date.now();
  if (settings.tapDelay && (now - lastTapTime) < TAP_DELAY) {
    return;
  }
  lastTapTime = now;
  
  if(settings.vibration && navigator.vibrate) {
    navigator.vibrate(30);
  }
  
  // –í—Å–µ–≥–¥–∞ +1 –æ—á–∫–æ
  const add = 1;
  score += add;
  scoreChip.textContent = score;

  // –≠—Ñ—Ñ–µ–∫—Ç –∫–ª–∏–∫–∞
  if (settings.clickEffect) {
    square.classList.add('active');
    setTimeout(() => square.classList.remove('active'), 300);
  }
  
  showPopup(`+${add}`, e.clientX, e.clientY);
  
  if(settings.particles) {
    emitParticles(e.clientX, e.clientY, chosenSkin.accent);
  }
  
  if(settings.sound) {
    sndHit.volume = settings.soundVolume;
    sndHit.currentTime = 0; 
    sndHit.play().catch(()=>{});
  }
  
  moveSquare();
});

function showPopup(text,x,y){
  const el = document.createElement('div');
  el.className = 'pop';
  el.textContent = text;
  el.style.left = (x) + 'px'; 
  el.style.top = (y - 10) + 'px';
  el.style.color = chosenSkin.accent;
  el.style.fontSize = '22px';
  el.style.fontWeight = '900';
  document.body.appendChild(el);
  setTimeout(()=>el.remove(),720);
}

/* PARTICLES */
function emitParticles(x,y,color){
  if(!settings.particles) return;
  
  const count = 16 + Math.floor(Math.random()*12);
  for(let i=0;i<count;i++){
    particles.push({
      x, y,
      vx: (Math.random()-0.5)*8,
      vy: (Math.random()-0.8)*8 - 2,
      life: 700 + Math.random()*300,
      born: performance.now(),
      size: 6 + Math.random()*10,
      color: color
    });
  }
}

function drawParticles(){
  if(!particleCtx || !settings.particles) return;
  const now = performance.now();
  particleCtx.clearRect(0,0,pc.width,pc.height);
  
  for(let i=particles.length-1;i>=0;i--){
    const p = particles[i];
    const t = (now - p.born);
    if(t>p.life){ particles.splice(i,1); continue; }
    const prog = t / p.life;
    p.vy += 0.06; 
    p.x += p.vx; 
    p.y += p.vy;
    const alpha = 1 - prog;
    
    particleCtx.globalAlpha = alpha;
    particleCtx.fillStyle = p.color;
    particleCtx.beginPath();
    particleCtx.ellipse(p.x, p.y, p.size*(1-prog), p.size*(1-prog), 0, 0, Math.PI*2);
    particleCtx.fill();
  }
  requestAnimationFrame(drawParticles);
}
requestAnimationFrame(drawParticles);

/* INIT */
function init() {
  const savedSettings = localStorage.getItem('gameSettings');
  if (savedSettings) {
    try {
      settings = JSON.parse(savedSettings);
    } catch (e) {
      console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫:', e);
    }
  }
  
  initSupabase();
  
  applySkin(chosenSkin);
  applySettings();
}

window.addEventListener('resize', ()=>{
  if(!gameRunning) return;
  const rect = square.getBoundingClientRect();
  const maxX = Math.max(window.innerWidth - 100, 20);
  const maxY = Math.max(window.innerHeight - 100, 20);
  const l = Math.min(rect.left, maxX), t = Math.min(rect.top, maxY);
  square.style.left = l + 'px'; 
  square.style.top = t + 'px';
});

/* prevent selection/dragging */
document.addEventListener('selectstart', e=>e.preventDefault());
document.addEventListener('dragstart', e=>e.preventDefault());

// –ó–∞–ø—É—Å–∫ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
window.addEventListener('DOMContentLoaded', init);
</script>
</body>
  </html>
